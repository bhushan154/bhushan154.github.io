<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/bootstrap.min.css" media="screen" />  
	<link rel="icon" type="image/x-icon" href="favicon4.ico">	
	<style type="text/css">
		body { padding-bottom: 70px; padding-top: 70px;}
		.socials {padding-top: 15px;} 
	</style>
    <title>Jiradev.com: Your guide to Jira Plugin Development</title>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>	
  </head>

  <body>
	
		<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
				<div class="navbar-header" style="padding-top: 5px;"><a  href="index.html"><img src="images/jiradevlogo.png" alt="Jiradev.com" max-height="40px"/></a></div>
				
				<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">
					<li class="active"><a href="tutorials.html">Tutorials</a></li>
					<li><a href="aboutme.html">About me</a></li>					
				</ul>
				<ul class="nav navbar-nav pull-right">
					<li class="socials"><a href="https://twitter.com/share" class="twitter-share-button" data-url="www.jiradev.com" data-text="Check out jiradev.com. It's got simple tutorials for devs new to Jira Development" data-via="jiradev" data-hashtags="JIRA,atlassian">Tweet</a></li>					
				</ul>
				</div>
			</nav>
	
	
    <div class="container">
      <div class="row">
		<div class="col-md-12">
        <div class="page-header"><h4>Workflow Condition Plugin</h4></div>
		
		<p><b>Requirement:</b> Write a workflow condition to check if a selected custom field has the value set to Yes.</p>
		
		<div class="alert alert-warning">There are already plugins that can perform this. I have just considered this as an example.</div>

		<p>
			<ol>
				<li>
					Create a plugin skeleton. 
					<div class="alert alert-info">
						<ul>
							<li>groupId: com.jiradev.jira.plugins</li>
							<li>artifactId: field-value-condition</li>
							<li>version: 1.0</li>
						</ul>
					</div>
				</li>
				<li>
					Cleanup the atlassian-plugin.xml. Then create a jira plugin module.
					<div class="alert alert-info">
						<ul>
							<li>Select option 32 for workflow condition</li>
							<li>Enter class name: FieldValueCondition</li>
							<li>Enter package name: com.jiradev.jira.plugins.conditions</li>
							<li>Show advanced setup: N</li>							
							<li>Add another plugin module: N</li>
						</ul>
					</div>
				</li>
				<li>
					Take a look at the atlassian-plugin.xml. Delete the test cases generated by the SDK. 
					<div class="alert alert-warning">We will not be covering test cases in these tutorials. I will be adding a separate series 
					of tutorials for testing in the near future.</div>
										
							<div><img class="img-thumbnail" src="images/lesson8/tests.png"/></div>
					
					<p>Your project now contains 4 new files. We will be modifying each of these files to implement 
					our logic and display content we want to display.
					<div class="alert alert-info">
						<ul>
							<li>FieldValueCondition.java</li>
							<li>FieldValueConditionFactory.java</li>
							<li>field-value-condition-input.vm</li>
							<li>field-value-condition-view.vm</li>
						</ul>
					</div>
					</p>
				</li>
			</ol>
		</p>
		<hr />	
		<p><h4>FieldValueConditionFactory.java</h4></p>

		<p>In this class, we will basically write code to setup the workflow condition. The code we write here will pass all the custom fields to the 
		view where we choose the custom field and the value required for the condition to pass.</p>
<pre>
package com.jiradev.jira.plugins.conditions;

import com.atlassian.core.util.map.EasyMap;
import com.atlassian.jira.component.ComponentAccessor;
import com.atlassian.jira.issue.fields.CustomField;
import com.atlassian.jira.plugin.workflow.AbstractWorkflowPluginFactory;
import com.atlassian.jira.plugin.workflow.WorkflowPluginConditionFactory;
import com.opensymphony.workflow.loader.AbstractDescriptor;
import com.opensymphony.workflow.loader.ConditionDescriptor;

import java.util.Map;

/*
This is the factory class responsible for dealing with the UI for the post-function.
This is typically where you put default values into the velocity context and where you store user input.
 */

public class FieldValueConditionFactory extends AbstractWorkflowPluginFactory implements WorkflowPluginConditionFactory
{
    public static final String CUSTOM_FIELDS = "customField";
    public static final String REQUIRED_VALUE = "value";

    protected void getVelocityParamsForInput(Map velocityParams)
    {
        //Popluate the velocityParams object with all the custom fields
        velocityParams.put("customFields", ComponentAccessor.getCustomFieldManager().getCustomFieldObjects());
    }

    protected void getVelocityParamsForEdit(Map velocityParams, AbstractDescriptor descriptor)
    {
        getVelocityParamsForInput(velocityParams);
        getVelocityParamsForView(velocityParams, descriptor);
    }

    protected void getVelocityParamsForView(Map velocityParams, AbstractDescriptor descriptor)
    {
        if (!(descriptor instanceof ConditionDescriptor))
        {
            throw new IllegalArgumentException("Descriptor must be a ConditionDescriptor.");
        }

        ConditionDescriptor conditionDescriptor = (ConditionDescriptor) descriptor;
        String customFieldId = conditionDescriptor.getArgs().get("selectedCustomField").toString();
        CustomField customField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject(customFieldId);
        velocityParams.put("requiredValue", conditionDescriptor.getArgs().get("requiredValue"));
        velocityParams.put("selectedCustomField", conditionDescriptor.getArgs().get("selectedCustomField"));
        velocityParams.put("selectedCustomFieldName", customField.getName());
    }

    public Map getDescriptorParams(Map conditionParams)
    {
        // Process The map
        String requiredValue = extractSingleParam(conditionParams, "requiredValue");
        String selectedCustomField = extractSingleParam(conditionParams, "selectedCustomField");
        return EasyMap.build("requiredValue", requiredValue,"selectedCustomField",selectedCustomField);
    }
}
</pre>	

<hr />
	<p><h4>field-value-condition-input.vm</h4></p>
	<p>We will now setup the view where the user selects the custom field and enters a value that is required for the condition to pass.</p>
<pre>
&lt;tr>
    &lt;td class="fieldLabelArea">
        Custom Field:
    &lt;/td>
    &lt;td nowrap>
        &lt;select name="selectedCustomField" id="selectedCustomField">
            #foreach($customField in $customFields)
                &lt;option name="$customField.getId()" id="$customField.getId" value="$customField.getId()"
                    #if($customField.getId() == $selectedCustomField)
                        selected
                    #end
                >$customField.getName()&lt;/option>
            #end
        &lt;/select>
    &lt;/td>
&lt;/tr>
&lt;tr>
    &lt;td class="fieldLabelArea">
        Required Value:
    &lt;/td>
    &lt;td nowrap>
        &lt;input name="requiredValue" id="requiredValue" value="${textutils.htmlEncode($requiredValue)}" />
    &lt;/td>
&lt;/tr>	
</pre>
	
	<p>The code above is responsible for rendering the below screenshot.</p>
	
	<div><img class="img-thumbnail" src="images/lesson8/input.png"/></div>
<hr />	
	<p><h4>field-value-condition-view.vm</h4></p>
<pre>
Custom field &lt;b>$selectedCustomFieldName&lt;/b> must have the value &lt;b>$requiredValue&lt;/b>
</pre>	

<p>The code above is responsible for rendering the below screenshot.</p>
	
	<div><img class="img-thumbnail" src="images/lesson8/view.png"/></div>

<hr />	
<p><h4>FieldValueCondition.java</h4></p>	

	<p>This class will contain the code to check the value of issue custom field and check if it equals the value expected by the user.</p>
	
<pre>
package com.jiradev.jira.plugins.conditions;

import com.atlassian.jira.component.ComponentAccessor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import com.atlassian.jira.issue.Issue;
import com.atlassian.jira.workflow.condition.AbstractJiraCondition;
import com.opensymphony.module.propertyset.PropertySet;

import java.util.Map;

public class FieldValueCondition extends AbstractJiraCondition
{
    private static final Logger log = LoggerFactory.getLogger(FieldValueCondition.class);

    public boolean passesCondition(Map transientVars, Map args, PropertySet ps)
    {
        String selectedCustomField = (String) args.get("selectedCustomField");
        String requiredValue = (String) args.get("requiredValue");
        Issue issue = getIssue(transientVars);
        Object value = issue.getCustomFieldValue(ComponentAccessor.getCustomFieldManager().getCustomFieldObject(selectedCustomField));
        if(value!=null)
            return value.toString().equals(requiredValue);
        else
            return false;
    }
}
</pre>	
	
	<hr />
	<p><h4>Testing the plugin</h4></p>
	
	<p>
		<ol>
			<li>Create a text custom field, and a new workflow. In one of the transitions, add the Field Value Condition.<br /><br />
							<img class="img-thumbnail" src="images/lesson8/condition.png"/><br /><br /></li>
			<li>In my example, I have a text field named <b>Analysis Complete?</b> and it has to contain the value <b>Yes</b>
			in order to pass the condition.</li>
			<li>Associate the workflow to a workflow scheme. Create a project that uses the workflow scheme.</li>
			<li>Try out the workflow and debug the code and check if your condition is working.</li>
		</ol>
	</p>

		</div>
	  </div>
    </div>

    <nav class="navbar navbar-default navbar-fixed-bottom">
		<div class="row">
			<div class="col-md-12">
				<p class="text-center">For more information about Jira Plugin Development and Training, contact <a href="mailto:bhushan154@gmail.com">Bhushan Nagaraj</a></p>
			</div>
		</div>
	</nav>
  </body>
</html>